before_script:
  - "source ~gitlab-runner/cicd_support/cicd_support.shinc" 


after_script:
  - "echo Test Complete."

stages:
  - clean
  - build
  - protect_bins
  - test
  - deploy


#
# Cleaning, build, test
#
.test: &test
  needs: []
  stage: clean
  script:
    - ./cicd_testing/do-clean.sh 
    - ./cicd_testing/do-build.sh
    - ./cicd_testing/eh-tests.sh
    - ./cicd_testing/builtin-xforms.sh
    - ./cicd_testing/elfdep.sh

# per os items
test-ubuntu18:
  <<: *test
  tags:
    - ubuntu18

test-coss9:
  <<: *test
  tags:
    - coss9

test-arm32:
  <<: *test
  tags:
    - arm32

test-arm64:
  <<: *test
  tags:
    - arm64

test-ubuntu20:
  <<: *test
  tags:
    - ubuntu20

test-ubuntu22:
  <<: *test
  tags:
    - ubuntu22



#
# gather artifacts and ship them tox 86 boxes
#
.gather-bins: &do_gather
        stage: build
        script:
            - ./cicd_testing/do-gather-bins.sh
        artifacts:               
            expire_in: 1 day
            paths:
                - artifacts/

gather-bins-arm32:
        <<: *do_gather
        tags:
            - arm32

gather-bins-arm64:
        <<: *do_gather
        tags:
            - arm64

#
# gather artifacts and ship them tox 86 boxes
#
.protect-arm-bins: &prot_bins
        needs: [gather-bins-arm32, gather-bins-arm64]
        stage: protect_bins
        script:
	    - ./cicd_testing/do-clean.sh 
	    - ./cicd_testing/do-build.sh
            - ./cicd_testing/do-prot-bins.sh
        artifacts:               
            expire_in: 1 day
            paths:
                - artifacts/

protect-arm-ubuntu22:
        <<: *prot_bins
        tags:
            - ubuntu22

#
# gather artifacts and ship them tox 86 boxes
#
.test_arm_bins: &test_arm_bins
        needs: [protect-arm-ubuntu22]
        stage: test
        script:
            - ./cicd_testing/do-test-bins.sh
        artifacts:               
            expire_in: 1 day
            paths:
                - artifacts/

test-bins-arm32:
        <<: *test_arm_bins
        tags:
            - arm32

test-bins-arm64:
        <<: *test_arm_bins
        tags:
            - arm64




# doesn't work yet
#builtin-xforms-arm32:
#  <<: *builtin-xforms
#  tags:
#    - arm32

builtin-xforms-arm64:
  <<: *builtin-xforms
  tags:
    - arm64


#
# elfdep test
#

# template
.elfdep: &elfdep
  stage: test
  script:

elfdep-ubuntu18:
  <<: *elfdep
  tags:
    - ubuntu18
    
elfdep-coss9:
  <<: *elfdep
  tags:
    - coss9
elfdep-ubuntu20:
  <<: *elfdep
  tags:
    - ubuntu20

elfdep-ubuntu22:
  <<: *elfdep
  tags:
    - ubuntu22


#
# deploy a docker image
#
deploy-u22:
  stage: deploy
  script:
    - ./cicd_testing/do-clean.sh 
    - ./cicd_testing/do-build.sh
    - ./cicd_testing/deploy.sh
  tags:
    - ubuntu22
