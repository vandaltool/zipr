before_script:
  - "source ~gitlab-runner/cicd_support/cicd_support.shinc" 
  - "git submodule sync --recursive"
  - "git submodule update --recursive --init"

after_script:
  - "source ~gitlab-runner/cicd_support/cicd_support.shinc" 

do-build:
  stage: build
  tags:
    - psz
  script:
    - "# gather info for debugging later, probably not necessary "
    - "pwd"
    - "hostname"
    - "whoami"
    - "env|grep CICD"
    - ""
    - "cp -r $CICD_TO_TEST_DIR /tmp/peasoup_test"
    - "cd /tmp/peasoup_test"
    - "source set_env_vars"
    - "sudo ./get-peasoup-packages.sh all"
    - "./build-all.sh --debug"
    - "./postgres_setup.sh"

xform-ls:
  stage: test
  tags:
    - psz
    - integration
  script:
    - "cd /tmp/peasoup_test"
    - "source set_env_vars"
    - "cd /tmp"
    - "rm -rf xxx ped_ls; $PSZ /bin/ls ./xxx -c rida=on -s meds_static=off --tempdir ped_ls || true"
    - "if [[ ! -x ./xxx ]]; then cat ped_ls/logs/*; fi"
    - "rm -rf ped_ls"
    - "./xxx"


basic-pgms-rida:
  stage: test
  tags:
    - psz
    - integration
  script:
    - "cd /tmp/peasoup_test"
    - "source set_env_vars"
    - "cd $CICD_TO_TEST_DIR/peasoup_examples/tests"
    - "cd $PEASOUP_HOME/tests; make clean; ./test_cmds.sh rida"

basic-pgms-rida-p1:
  stage: test
  tags:
    - psz
    - integration
  script:
    - "cd /tmp/peasoup_test"
    - "source set_env_vars"
    - "cd $CICD_TO_TEST_DIR/peasoup_examples/tests"
    - "cd $PEASOUP_HOME/tests; make clean; ./test_cmds.sh rida_p1"

