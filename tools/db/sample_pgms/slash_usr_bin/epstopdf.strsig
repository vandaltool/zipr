        }
# ----------------------------------------------------------------
#  1999/05/06 v2.5 (Heiko Oberdiek)
# 1. Redistributions of source code must retain the above copyright
#  2000/11/05 v2.6 (Heiko Oberdiek)
#  2001/03/05 v2.7 (Heiko Oberdiek)
#  2002/02/18 v2.8draft (Gerben Wierda)
#  2002/02/21 v2.8draft (Gerben Wierda)
#  2003/04/22 v2.9draft (Gerben Wierda)
#  2004/03/17 v2.9.1draft (Gerben Wierda)
#  2005/09/29 v2.9.2draft (Gerben Wierda)
#  2005/10/01 v2.9.3draft (Gerben Wierda)
#  2005/10/06 v2.9.4gw (Gerben Wierda)
#  2005/10/06 v2.9.5gw (Gerben Wierda)
#  2007/01/24 v2.9.6sw (Staszek Wawrykiewicz)
#  2007/05/15 v2.9.6tp (Theo Papadopoulo)
#  2007/05/18 v.2.9.7gw (Gerben Wierda)
#  2007/07/18 v2.9.8gw
#  2008/08/26 v2.9.9gw
#  2009/05/09 v2.9.10gw
#  2009/07/17 v2.9.11gw
#  2009/09/27 v2.11 (Karl Berry)
#  2009/10/14       (Manuel P\'egouri\'e-Gonnard)
#  2009/10/18       (Manuel P\'egouri\'e-Gonnard)
#  2009/11/25       (Manuel P\'egouri\'e-Gonnard)
#  2009/11/27 v2.12 (Karl Berry)
#  2010/02/23       (Manuel P\'egouri\'e-Gonnard)
#  2010/02/26 v2.13 (Karl Berry)
#  2010/03/08 v2.14 (Manuel P\'egouri\'e-Gonnard)
#  2010/03/19 v2.15 (Karl Berry)
# 2. Redistributions in binary form must reproduce the above copyright
# 3. The name of the author may not be used to endorse or promote
### actually run GS if we were writing to a temporary file
#    * Added BSD-style license
#    * Added -dSAFER to default gs options
#    * Added resolution switch (D. Kreil)
#    * Added restricted mode.
#   a) it is guaranteed to start at the 0,0 coordinate.
#	allowing epstopdf to run. However without -dSAFER Ghostscript
#	allows writing to files (other than given in -sOutputFile)
    and not safe_name('in', $InputFilename)) {
#	and running commands (through Ghostscript pipe's language feature).
# ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
#    * Applied fix from Peder Axensten for Freehand bug
  @ARGV == 0 or
  @ARGV > 0 or errorUsage "Input filename missing";
  @ARGV < 2 or errorUsage "Unknown option or too many input files";
#    * (atend) supported.
#    attacks with rogue versions of these programs in the current directory.
  # at the end. Then split the buffer in an array. We will draw lines from
  "autorotate=s",	# \ref{val_autorotate}
  --autorotate=VAL   set AutoRotatePages   (default: $rotmsg)
          $BBCorrected = 1;
      $BBCorrected = 1;
$BBName = "%%ExactBoundingBox:" if $::opt_exact;
$BBName = "%%HiResBoundingBox:" if $::opt_hires;
#    * Better argument validation (Alexander Cherepanov).
#    * Better extension detection, suggested by A. Cherepanov.
binmode IN;
binmode $OUT;
#   b) it sets a page size exactly corresponding to the BoundingBox
# "%%BoundingBox: (atend)" when input is not seekable (e.g., from a pipe),
#      BoundingBox of an included file.
    ### BoundingBox with (atend)
    ### BoundingBox with values
    @bufarray = split(/^/ms, $buf);
    @bufarray = split(/(?<=\r)/ms, $buf); # split after \r
  $buf .= <IN> unless eof(IN);
  $buflen = length($buf);
$buflen = read(IN, $buf, $EOLSCANBUFSIZE);
    $buf =~ s/(.*?)%!/%!/o;
#    * Call external programs with full path on win32 in order to avoid obvious
  # cannot split on ^, but have to split on a look-behind for \r.
#    * Changed cygwin name for ghostscript to gs
#    * changed first comment from '%!PS' to '%!';
### check if a name is "safe" according to kpse's open(in|out)_any
### close files
close(IN);
close($OUT);
  "compress!",
# construction should work with most shells.
Convert EPS to PDF, by default using Ghostscript.
Copyright 1998-2001 Sebastian Rahtz et al.
Copyright 2002-2009 Gerben Wierda et al.
Copyright 2009-2010 Karl Berry et al.
# (Copyright lines below.)
          CorrectBoundingBox $1, $2, $3, $4;
      CorrectBoundingBox $1, $2, $3, $4;
#    * corrected (atend) pattern: '\s*\(atend\)'
#    * corrected first line (one line instead of two before 'if 0;';
#      correct the first white space to '...Box:\s*$bb...'
#    * Create source repository in TeX Live
  $crlfpos = index($buf, "\r\n");
# cropping, and the PDF MediaBox is correct.
  $crpos = index($buf, "\r");
#   c) the result is piped to Ghostscript and a PDF version written.
  "debug!",
      debug $BBName, "(atend)";
debug "BoundingBox comment:", $BBName;
  debug "Compression:", ($::opt_compress) ? "on" : "off";
      debug "Current file position:", $pos;
debug "Done.";
  debug "Embedding:", ($::opt_embed) ? "on" : "off";
  debug "Filtering: will read standard input";
      debug "Filtering: will write standard output";
  debug "Ghostscript command:", $GS;
  debug "Ghostscript command:", join(' ', @GS);
    debug "Ghostscript pipe:", join(' ', @GS);
  debug "Input filename:", $InputFilename;
debug "kpsewhich command: $kpsewhich";
  debug "New BoundingBox: 0 0", $width, $height;
    debug "No Ghostscript: will write standard output";
  debug "Offset:", $xoffset, $yoffset;
  debug "Old BoundingBox:", $llx, $lly, $urx, $ury;
debug "Output filename:", $OutputFilename;
  debug "Resolution:", $resmsg;
debug "Restricted mode activated" if $restricted;
  debug "Rotation:", $rotmsg;
debug "Scanning header for BoundingBox";
    debug "Switching from $GS to $::opt_gscmd";
    debug "The first eol character was a CR ($crpos) and not immediately followed by a LF ($lfpos)";
    debug "Using temporary file '$tmp_filename'";
#    * Detecting of cygwin perl
# DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
#    documentation and/or other materials provided with the distribution.
  '-dSubsetFonts=true', '-dEmbedAllFonts=true') if $::opt_embed;
    } else {
  } else {
  else {
} else {
  } else { # use a temporary file on Windows/Cygwin.
} elsif ($? != 0) {
# emacs-page
### emacs-page
  "embed!",
END_COPYRIGHT
    ### end of header
END_OF_USAGE
  # entire file
epstopdf home page: <http://tug.org/epstopdf/>
  error "Input filename '$InputFilename' not allowed in restricted mode.";
error "Invalid value for autorotate: '$::opt_autorotate' "
    error "Option forbidden in restricted mode: --gscmd";
  error "Options --hires and --exact cannot be used together";
  error "Output filename '$OutputFilename' not allowed in restricted mode.";
  error(sprintf "Writing to $outname failed, error code %d\n", $? >> 8);
  error(sprintf "Writing to $outname failed, signal %d\n", $? & 127);
  error "Unknown check mode in safe_name(): $mode" unless $option;
    errorUsage "Input file cannot be used with filter option";
eval '(exit $?0)' && eval 'exec perl -S $0 ${1+"$@"}' && eval 'exec perl -S $0 $argv:q'
  "exact!",
Example: look for HiResBoundingBox and produce corrected PostScript:
Examples producing test.pdf:
  exit (0);
  "filter!",
#    * Fixed a horrendous bug in the (atend) handling code
#    * Fixed bug where last line of buffer was not copied out (ugh!)
#    * Fixed bug where with cr-eol files everything up to the first %!
#    * Fixed two bugs in the (atend) handling code (Martin von Gagern)
    ### Fix for freehand bug ### by Peder Axensten
                      For EPS files, PageByPage is equivalent to All
### get input filename (\ref{openin_any} for validation)
### getline
getline();
GetOptions (
### ghostscript command name
      # Ghostscript, no filter: replace input extension with .pdf.
      # go back
  "gs!",
  "gscmd=s", 		# \ref{val_gscmd}
  --gscmd=VAL        pipe output to VAL    (default: $GS)
  $GS = "$mydirname/../../../tlpkg/tlgs/bin/$GS";
    $GS = $::opt_gscmd;
#    * Handle different eol styles transparantly
$header = 1 if /^%/;
  HEADER: while (getline()) {
  "help",
  --help             display this help and exit
### help functions
### help, version options.
  "hires!",
#    * %%HiresBoundingBox corrected to %%HiResBoundingBox
# History
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
# $Id: epstopdf.pl 17496 2010-03-18 17:57:31Z karl $
if (/%!/) {
if ($? & 127) {
    if (/^$BBName$BBValues/o) {
    if (/^$BBName\s*\(atend\)/) {
  if ($buf =~ /%!/) {
  if ($#bufarray >= 0) {
if ($buflen > 0) {
  if ($crpos > 0 and ($lfpos == -1 or $lfpos > $crpos+1)) {
if (defined $tmp_filename) {
  if ($/ eq "\r") {
# if ghostscript exited badly, we should too.
if ($header) {
        if ($nestDepth == 0 && /^$BBName$BBValues/o) {
  if (! $on_windows_or_cygwin) { # list piped open works
  if ($::opt_autorotate and
      if ($::opt_filter) {
    if ($::opt_filter) {
if ($::opt_filter) {
  if ($::opt_gs) {
if ($::opt_gs) {
if ($::opt_gscmd) {
if ($::opt_help) {
if ($::opt_version) {
    if (!/^%/ or /^%%EndComments/) {
if (! $OutputFilename) {
if ($restricted and not $::opt_filter
if ($restricted and not safe_name('out', $OutputFilename)) {
  if ($restricted) { # \label{val_gscmd}
if ($restricted && $on_windows) {
# If the input bounding box is not right, of course there will be problems.
  # if there is no header, we assume the file starts with ascii style and
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
#    * Improved handling of CR line ending (Martin von Gagern)
    $_ = <IN>;
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  $InputFilename = $ARGV[0];
  $inputpos = 0;
    $inputpos = length($1);
  $inputpos += length($_) if defined $_;
#    * In restricted mode, forbid --gscmd (all platforms) and call GS with full
#    * in the first 2048 bytes was gobbled (double ugh!)
# It needs a Level 2 PS interpreter.
  # it to our buffer. This will make the buffer contain an entire line
  $kpsewhich = "$mydirname/../../../bin/win32/$kpsewhich";
# \label{val_autorotate}
          last;
        last;
      last;
#    * let --outfile override --filter again.
  $lfpos = index($buf, "\n");
License RBSD: Revised BSD <http://www.xfree86.org/3.3.6/COPYRIGHT2.html#5>
      # looking for %%BoundingBox
#    * Make --filter work again
#    * Many cosmetics: title, usage, ...
#    * Merged both supplied 2.9.6 versions
# modification, are permitted provided that the following conditions are met:
#    * More error checking
  my @args = ($kpsewhich, '-progname', 'repstopdf', $option, $name);
  my $bad = system {$args[0]} @args;
my $BBCorrected = 0;
my $BBName = "%%BoundingBox:";
my $BBValues = "\\s*($bbxpatt+)\\s+($bbxpatt+)\\s+($bbxpatt+)\\s+($bbxpatt+)";
my $bbxpatt = '[0-9eE\.\-]';
my @bool = ("false", "true");
my $buf;
my @bufarray;
my $buflen;
my $copyright = <<END_COPYRIGHT ;
  my $crlfpos;
  my $crpos;
  # $mydirname is the location of the Perl script
      my $ds = $on_windows_or_cygwin ? '\\/' : '/';
my $EOLSCANBUFSIZE = 2048;
my @GS = ($GS);
my $GS = $on_windows ? "gswin32c" : "gs";
my $header = 0;
my $ident = '($Id: epstopdf.pl 17496 2010-03-18 17:57:31Z karl $) 2.15';
my $InputFilename = "";
my $inputpos;
my $kpsewhich = 'kpsewhich';
  my $lfpos;
  my ($llx, $lly, $urx, $ury) = @_;
  my ($mode, $name) = @_;
  my $mydirname = dirname $0;
        my $nestDepth = 0;
my $on_windows = $^O =~ /^MSWin/;
my $on_windows_or_cygwin = $on_windows || $^O eq "cygwin";
  my $option = "";
my $OUT; # filehandle for output (GS pipe or temporary file)
my $outname;  # used in error message at end
my $OutputFilename = $::opt_outfile;
      my $pos = $inputpos;
my $program = "epstopdf";
my $resmsg = $::opt_res ? $::opt_res : "[use gs default]";
my $restricted = 0;
my $rotmsg = $::opt_autorotate ? $::opt_autorotate : "[use gs default]";
my $title = "$program $ident\n";
my $tmp_filename; # temporary file for windows
my $usage = <<"END_OF_USAGE";
  my ($width, $height) = ($urx - $llx, $ury - $lly);
  my ($xoffset, $yoffset) = (-$llx, -$lly);
        $nestDepth++ if /^%%BeginDocument/;
        $nestDepth-- if /^%%EndDocument/;
#    * New code for debug, warning, error
#    * Newline before grestore for the case that there is no
#    * New options: --hires, --exact, --filter, --help.
#    * New release.
    next HEADER if(!/\S/);
#    * No autorotate page
  --(no)compress     use compression       (default: $bool[$::opt_compress])
  --(no)debug        write debugging info  (default: $bool[$::opt_debug])
  --(no)embed        embed fonts           (default: $bool[$::opt_embed])
  --(no)exact        scan ExactBoundingBox (default: $bool[$::opt_exact])
  --(no)filter       read standard input   (default: $bool[$::opt_filter])
  --(no)gs           run ghostscript       (default: $bool[$::opt_gs])
  --(no)hires        scan HiResBoundingBox (default: $bool[$::opt_hires])
#    notice, this list of conditions and the following disclaimer.
#    notice, this list of conditions and the following disclaimer in the
    not $::opt_autorotate =~ /^(None|All|PageByPage)$/);
  # Now we have set the correct eol-character. Get one more line and add
# One thing not allowed for: the case of
  open(IN, '<-') || error("Cannot open stdin: $!");
  open(IN, '<', $InputFilename) || error("Cannot open $InputFilename: $!");
### open input file
    open($OUT, '|-', @GS) or error "Cannot open Ghostscript for piped input";
  open($OUT, '>', $OutputFilename) or error "Cannot write \"$OutputFilename\"";
### open output file
$::opt_autorotate = "None";
$::opt_compress = 1;
$::opt_debug = 0;
$::opt_embed = 1;
$::opt_exact = 0;
$::opt_filter = 0;
$::opt_gs = 1;
$::opt_gscmd = "";
$::opt_hires = 0;
!($::opt_hires and $::opt_exact) or
### option BoundingBox types
### option gs
### option gscmd
### option outfile
### options
Options:
  $option = '-safe-in-name'  if $mode eq 'in';
  $option = '-safe-out-name' if $mode eq 'out';
### options compress, embed, res, autorotate
options so the problem can be reproduced.
$::opt_outfile = "";
$::opt_res = 0;
) or die $usage;
# Originally by Sebastian Rahtz, for Elsevier Science
  --outfile=FILE     write result to FILE
  "outfile=s", 		# \ref{openout_any}
  $outname = $GS;
  $outname = $OutputFilename;
      $OutputFilename = "-";
      $OutputFilename = $InputFilename;
    $OutputFilename = "-"; # no ghostscript, write to standard output
      $OutputFilename .= ".pdf";
      $OutputFilename =~ s/\.[^\.$ds]*$//;
#    output. Requires kpathsea 5.1.0 (TL2010), rejects the name with earlier
    ($OUT, $tmp_filename) = tempfile(UNLINK => 1);
#    * patched to work also on Windows
#    path relative to self location (Windows).
# perl along $PATH rather than guessing a fixed location. The above
#    permission.
# POSSIBILITY OF SUCH DAMAGE.
  print $copyright;
    # print header line
      print $OUT $_;
    print $OUT $_;
  print $OUT $_;
print $OUT $_;
  print $OUT "%%BoundingBox: 0 0 $width $height$/";
print $OUT "$/grestore$/" if $BBCorrected;
  print $OUT "gsave $xoffset $yoffset translate$/";
  print $OUT "<< /PageSize [$width $height] >> setpagedevice$/";
### print rest of file
  print $title;
  print $usage;
### process options
  * produce postscript | $program -f -d -o=test.pdf
  * produce postscript | $program --filter >test.pdf
#    products derived from this software without specific prior written
  * $program -d --nogs --hires test.ps >testcorr.ps
### program identification
  * $program test.eps
               # protect backslashes: "\\" gets '\'
push @GS, "-dAutoRotatePages=/$::opt_autorotate" if $::opt_autorotate;
push @GS, ('-dPDFSETTINGS=/prepress', '-dMaxSubsetPct=100',
push @GS, '-dUseFlateCompression=false' unless $::opt_compress;
    push @GS, qw(- -c quit);
  push @GS, qw(-c quit);
push @GS, qw(-q -dNOPAUSE -dSAFER -sDEVICE=pdfwrite);
push @GS, "-r$::opt_res" if $::opt_res;
push @GS, "-sOutputFile=$OutputFilename";
  push @GS, $tmp_filename;
#    * Quote OutFilename
    $/ = "\r";
# reading a cr-eol file on a lf-eol system makes it impossible to parse
                      Recognized VAL choices: None, All, PageByPage
#    * recognize MSWin64 as well as MSWin32, just in case.
# Redistribution and use in source and binary forms, with or without
  # remove binary junk before header
Report bugs to: tex-k\@tug.org
  --res=DPI          set image resolution  (default: $resmsg)
  "res=i",		# validated by getopt ('i' specifier)
$resmsg= $::opt_res ? $::opt_res : "[use gs default]";
  "restricted",
$restricted = 1 if $0 =~ /repstopdf/;
$restricted = 1 if $::opt_restricted;
### restricted mode
### restricted option
  --restricted       use restricted mode   (default: $bool[$restricted])
  return ! $bad;
  return defined($_);
# return true if name is ok, false otherwise
  #-r $InputFilename or error "\"$InputFilename\" not readable";
$rotmsg = $::opt_autorotate ? $::opt_autorotate : "[use gs default]";
### safer external commands for Windows in restricted mode
# scalar. this is also true the other way around.
### scan a block, try to determine eol style
### scan first line
### scan header
#    * Scanning for %%{Hires,Exact,}BoundingBox.
#    * Scanning only the header in order not to get a wrong
      seek(IN, $pos, 0) or error "Cannot go back to line \"$BBName (atend)\"";
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
    $_ = shift(@bufarray);
#    * Simplified the (atend) support
#    Since Perl's fork() emulation doesn't work on Windows with Perl 5.8.8 from
        # skip over included documents
  s/(.*)%!/%!/o;
  # Some extra magic is needed here: if we set $/ to \r, Perl's re engine
### start building GS command line for the pipe
  # still thinks eol is \n in regular expressions (not very nice) so we
# STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
sub CorrectBoundingBox
sub debug      { print STDERR "* @_\n" if $::opt_debug; }
sub error      { die "$title!!! Error: @_\n"; }
sub errorUsage { die "Error: @_ (try --help for more information)\n"; }
sub getline
sub safe_name
sub warning    { print STDERR "==> Warning: @_\n"; }
#    * Switch to embed fonts (default=yes) (J.P. Chretien)
  system @GS;
#    TeX Live 2009, use a temporary file instead of a pipe on Windows.
  # that array until it is empty, then move again back to <IN>
    # The first eol was a cr and it was not immediately followed by a lf
# the header and besides it will read the intire file into yor line by line
There is NO WARRANTY, to the extent permitted by law.
#    * This has become the official version for now
# This is a script to transform an EPS file such that:
This is free software: you are free to change and redistribute it.
# This means that when Ghostscript renders it, the result needs no
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# Thomas Esser, Sept. 1998: change initial lines to find
    # throw away binary junk before %!
  # throw away binary junk before %!
${title}Usage: $program [OPTION]... [EPSFILE]
#	TL2009 wants to use a restricted variant of -shell-escape,
#    * turned no AutoRotatePages into an option (D. Kreil) (default = None)
### usage
  . "(use 'All', 'None' or 'PageByPage')."
  use File::Basename;
use File::Temp 'tempfile';
use Getopt::Long;
#    * Use kpsewhich for filename validation in restricted mode, both input and
#    * Use list form of pipe open() (resp. system()) to prevent injection.
#    * uses strict; (earlier error detecting).
use strict;
#    * using of $bbxpat in all BoundingBox cases,
### validate input file name in restricted mode \label{openin_any}
### validate output file name in restricted mode \label{openout_any}
### variables and pattern for BoundingBox search
  "version",
  --version          display version information and exit
#    * --version option
#    versions of kpsewhich.
# vim: ts=8 sw=2 expandtab:
warning "BoundingBox not found" unless $BBCorrected;
        warning "Cannot look for BoundingBox in the trailer",
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# We assume 2048 is big enough.
  # we look for a eol style anyway, to prevent possible loading of the
When reporting bugs, please include an input file and command line
      while (getline()) {
while (getline()) {
#      whitespace at the end of the eps file.
# with extra tricks from Hans Hagen's texutil and many more.
                "with option --filter";
