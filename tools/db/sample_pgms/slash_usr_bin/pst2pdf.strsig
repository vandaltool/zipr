            }
          }
        }
        } 				
# 2007-08-28	(c) hvoss@tug.org 
# along with this program; if not, write to the
along with this program; if not, write to the Free Software
@ARGV == 0 && die "file name expected!\n";
(at your option) any later version.
B<pst2pdf> - run a TeX source, and convert all PS-related part as single images
but WITHOUT ANY WARRANTY; without even the implied warranty of
    chomp;
--clear 
                         "clear"      => \$clear,    # flag
  close (FILE);
  close(FILE);
  close FILE;						# close source file
    close (FILEp);
  close(FILEp);
      close(FILEp);  					# close preamble
    close (FILEsub);
close LOGfile;
  close (PDF);
Copyright (c) 2007  Herbert Voss <hvoss@tug.org>
            $depth--; 
	    $depth--; 
	  $depth++;  
            $depth++; 					# pspicture env
    } # do nothing until \end{verbatim}
    } # do nothing until \end{verbatim}|| \end{lstlisting}
--DPI=<int> 
    } else { 
  else { mkdir("$imageDir", 0744) || die "cannot mkdir $imageDir: $!";
    } else { print PDF $_; } # if ( $iVerb )
	    else { print PDF substr($_,$iPST+14); }	# \end{pspicture} 
        } else { push @PS,$line; }		# add line
	  } else { push @PS,$line; }	# pspicture inside postscript
	      else { push @PS,substr($line,0,$iPST+14); }	# \end{pspicture} 
        } elsif ($iPS > 0) { 		# must be type=1 -> stop Scan
        elsif ( $iPST > 0 ) { 		# we have \begin{pspicture} or \pspicture
        } elsif ( $type == 1 ) {				# pspicture env
          }							# end Scan
eval '(exit $?0)' && eval 'exec perl -S $0 ${1+"$@"}' && eval 'exec perl -S $0 $argv:q'
      foreach ( @a ) { LOG ($a[$i]); $i++; }
      foreach ( @a ) { print LOG $a[$i]."\n"; $i++; }
    foreach ( @PS ) { print FILEsub "$_\n"; }
    for my $aref ( @PSarray ) { 
  for my $aref ( @PSarray ) {
    for my $aref ( @PStotal ) { 
  for my $Itype ( @imageType ) {
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
# Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
GNU General Public License for more details.
=head1 AUTHORS
=head1 COPYRIGHT
=head1 DESCRIPTION
=head1 NAME
=head1 OPTIONS
=head1 SYNOPSIS
Herbert Voss <hvoss@tug.org>
--Iext=<.ext> 
                         "Iext=s"     => \$Iext,     # string
  if ( $clear ) {
if ( $clear ) {
	    if ( $depth == 0 ) {
	    if ($depth < 0) { 
            if ($depth < 0) { $ignore = 0; }
  if (-d $imageDir) { LOG ("$imageDir exists") }
      } # if ( !$EndDocument ) 
      if ( !$EndDocument ) {
    if (!$EndDocument) {
if ( $ext eq "" ) { $ext = ".tex"; }	# me need the extension as well
    if ($i > 0) { 
      if ($i > 0) { $EndDocument++; LOG("EndDocument in searchPS"); }
      if ($i > 0) { print PDF $_; $EndDocument++; LOG("EndDocument in runpdfTeX"); }
      if ($i > 1) { print FILEp substr($_,0,--$i); }	# write all until \begin{document}
        if ( !$ignore ) { print PDF "$_"; }			# default line
	    if (index($_,"endpspicture") > 0) 		# add rest of line, depends to type
    if (( index($_,"end{verbatim}") > 0 ) or ( index($_,"end{lstlisting}") > 0 )) { $iVerb = 0; }
	      if (index($line,"endpspicture") > 0) 		# add line, depends to type
    if (( index($line,"end{verbatim}") > 0 ) or ( index($line,"end{lstlisting}") > 0 )) { $iVerb = 0; }
          if ($iPS > 0) {
        if ( $iPS > 0 ) { 
      if (($iPS > 0) && ( $type == 1 )){ print "postscript environment must be outer level!\n"; exit 1; }
        if ($iPS > 0) { 			# we have \begin{postscript}
          if ($iPS > 1) { print PDF substr($_,0,--$iPS); }	# add preceeding text
          if ($iPST > 0) {		 			# end Scan
          if ($iPST < 0) { $iPST = index($_,"endpspicture"); }	# alternative \endpspicture...
        if ($iPST < 0) { $iPST = index($line,"endpspicture"); }	# alternative \endpspicture...
      if ($iPST < 0) { $iPST = index($line,"pspicture"); }	# alternative \pspicture...
          if ($iPST < 0) { $iPST = index($_,"\\pspicture"); }	# alternative \endpspicture...
          if ( $iPST >= 0 ) {	 			# start Scan
        if ($iPST > 0) {		# test, we can have postscript and pspicture in one line
              if ($iPST > 1) { print PDF substr($_,0,--$iPST); }# add preceeding text
    if ($Itype eq "eps") { system("pdftops -f 1 -l 1 -eps $imageDir/$filename-$imgNo.pdf $imageDir/$filename-$imgNo.eps"); }
    if ($Itype eq "pdf") { system("pdfcrop $filename.pdf $imageDir/$filename-$imgNo.pdf");  }
    if ($Itype eq "png") { 
    } # if ( $iVerb )
    if ( !$iVerb ) {
    if ( !$iVerb ) { 
if ( !$noImages ) {
      if ( $type < 0 ) {			# no active environment
      if ($type > 0) {			# start Scan, we have an environment
        if ( $type < 2 ) {
          if ( $type < 2) {		# found end of pspicture environment 
        if ( $type == 2 ) {					# postscript env
  if ( $verbose ) { 
  if ( $verbose ) { LOG("<-----Preamble<----"); }
    if ( $verbose ) { LOG("\@PS: $_"); }
  if ( $verbose ) { print LOGfile "@_\n"; } 
# if we have a \input command inside the preamble, it doesn't hurt, we need
            $ignore = 0; 
            $ignore = 1;
          $ignore = 1; 
--imageDir  
                         "imageDir=s" => \$imageDir, # string
  $imgNo++;
              $IMGno++;
          $IMGno++;
        $iPS = index($line,"end{postscript}");	
        $iPST = index($line,"end{pspicture}");
                         "Iscale=f"   => \$Iscale,   # real
--Iscale=<real> 
# it anyway for the postscript files and the pdf one.
# it under the terms of the GNU General Public License as published by
it under the terms of the GNU General Public License as published by
      $iVerb = ((index($_,"begin{verbatim}") > 0) or (index($_,"begin{lstlisting}") > 0)); 
      $iVerb = ((index($line,"begin{verbatim}") > 0) or (index($line,"begin{lstlisting}") > 0)); 
          $line = substr($line,$iPS-1);	# add rest of the line
          $line = substr($line,$iPST-1);	# add all unitl pspicture
      LOG ("$_"); 
LOG ("all finished ... :-)"); 
LOG ("==> clear    = $clear"); 
      LOG ("----- Close Preamble ------"); 
	    LOG("Decrease depth: $depth");
  LOG ("done!"); 
  LOG ("done!\n go to runFile ..."); 
LOG ("==> DPI      = $DPI"); 
  LOG ("go to savePreamble ... "); 
LOG ("==> Iext     = $Iext"); 
    LOG ("Imagedir created"); }
LOG ("==> imageDir = $imageDir"); 
	    LOG("Increase depth: $depth");
	      LOG("Increase Image counter: $IMGno");
LOG ("==> Iscale   = $Iscale"); 
LOG ("==> noImages = $noImages"); 
LOG ("Parameters:"); 
    LOG("<----PSarray<----"); 
    LOG("---->PSarray---->");
    LOG("PS: ".$no." PS sequence(s)"); 
              LOG ("---->PS---->\n@PS\n<----PS<----"); 
          LOG ("---->PS---->\n@PS\n<----PS<----"); 
    LOG ("<----PStotal<----"); 
    LOG("---->PStotal---->");
	  LOG("PST-Zeile: $line");
  	  LOG("PS-Zeile: $line");
LOG ("Running on [$path][$name][$ext]"); 
LOG ("runpdfTeX ... "); 
            LOG ("searchPS: $line"); 
          LOG ("searchPS: $line"); 
              LOG ("searchPS: set \$type=$type"); 
          LOG ("searchPS: set \$type=$type"); 
        LOG ("searchPS: set \$type=$type"); 
  LOG ("----- Start Preamble -----"); 
LOG ("==> tempDir  = $tempDir"); 
LOG ("==> verbose  = $verbose"); 
# MA  02111-1307  USA
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
      my @a = @$aref;
my $clear = 0;				# 0 or 1, clears all temporary files
  my $depth = -1;
  my $depth = -1;			# counts nested macros
my $DPI = 75;				# very low value
  my $EndDocument = 0;			# ignore all after \end{document}
  my $filename = pop;
  my $filename = pop;			# get the file name
      my $i = 0;
my $Iext = ".pdf";			# leave empty, if not a special one
  my $ignore = 0;
    my $i = index($_,"begin{document}");
      my $i = index($_,"end{document}");
      my $i = index($line,"end{document}");
my $imageDir = "images";		# where to save the images
my @imageType = ("eps","pdf");		# all image types
#my @imageType = ("eps","pdf","png");	# all image types (png only for Linux)
  my $IMGno = 0;
my $imgNo = 0;				# internal image counter
        my $iPS = index($_,"begin{postscript}");
          my $iPS = index($_,"end{postscript}");
      my $iPS = index($line,"begin{postscript}");
          my $iPST = index($_,"begin{pspicture}");
          my $iPST = index($_,"end{pspicture}");
      my $iPST = index($line,"begin{pspicture}");
my $Iscale = 1;				# for \includegraphics
  my $iVerb = 0;
  my $iVerb = 0;			# test for verbatim or lstlisting environment, must be ignored
    my $line = $_; 
my $Logfile = "$tempDir/$name.plog";	# our own log file
my ($name,$path,$ext) = fileparse($ARGV[0],@SuffixList);
  my ($name,$pdfname) = @_;
my $noImages = 0;			# 1->create no images
    my $no = @PSarray;
    my @PS = @$aref;
  my @PSarray = searchPS();
  my @PS = ();				# single PS sequence
  my @PStotal = ();			# all PS sequences as list of arrays
my $result = GetOptions ("DPI=i"      => \$DPI,      # numeric
my @SuffixList = (".tex","",".ltx");	# possible extensions
my $tempDir = ".";			# temporary directory
my $TeXfile = "$path$name$ext";
  my $type = -1;
  my $type = -1;			# -1-> none; 1->PST; 2->PS; 
my $verbose = 1;			# 0 or 1, logfile  
--noImages 
}# !noImages
                         "noImages"   => \$noImages, # flag
	    }				# no pspicture env left
  open (FILE, "<$name.tex") or die "cannot open $name!";
  open (FILEp, ">$tempDir/$filename.preamble") 
    open (FILEp, "<$tempDir/$filename.preamble") or die "cannot open $tempDir/$filename.preamble!";
    open (FILEsub, ">$tempDir/$filename-tmp.tex") or die "cannot open $tempDir/$filename-tmp.tex!";
open (FILE, "<$TeXfile") or die "cannot open source file $TeXfile!";	# the source
open (LOGfile, ">$Logfile") or die "cannot open $Logfile!";
  open (PDF, ">$tempDir/$pdfname-pdf.tex") or die "cannot open $tempDir/$pdfname-pdf.tex!";
    or die "cannot open preamble file $tempDir/$filename.preamble!";
    (pdf and/or eps and/or png and/or ...) and then runs pdflatex.
        }		# postscript env
      print FILEp "$_"; 				# write into preamble
    print FILEsub "\\begin{document}\n";
    print FILEsub "\\end{document}\n";
    print FILEsub "\\newenvironment{postscript}{}{}\n";
    print FILEsub "\\pagestyle{empty}\n";
#  print PDF "\\graphicspath{{$imageDir/}}\n";
#              print PDF "\\includegraphics{$name-tmp-$IMGno$Iext}"; 	# use \graphicspath
#          print PDF "\\includegraphics{$name-tmp-$IMGno$Iext}"; 	# use \graphicspath
              print PDF "\\includegraphics[scale=$Iscale]{$imageDir/$name-tmp-$IMGno$Iext}"; 
          print PDF "\\includegraphics[scale=$Iscale]{$imageDir/$name-tmp-$IMGno$Iext}"; 
  print PDF "\\RequirePackage{graphicx}\n";
  print PDF "\\RequirePackage[pdftex]{xcolor}\n";
#  print PDF "\\setkeys{Gin}{scale=0.25}\n";
            print PDF substr($_,$iPS+15);			# rest of line
	       { print PDF substr($_,$iPST+12); }	# \endpspicture
	      @PS = ();			# start new PS sequence
	  @PS = ();			# start new PS sequence
  pst2pdf.pl <texfile[,tex]>  [Options]
    	  push @PS,substr($line,0,$iPS+15);# add line
	           { push @PS,substr($line,0,$iPST+12); }	# \endpspicture
              push @PStotal,[@PS];	# add PS sequence
          push @PStotal,[@PS];		# add PS sequence
      return; 
  return;
  return @PStotal;			# return all PS sequences
  runFile($name);
runpdfTeX("$path$name",$name);
runs latex and pdflatex on the TeX 
    runTeX("$tempDir/$filename-tmp");
  savePreamble($name);
# See the GNU General Public License for more details.
sub LOG() { 
sub runFile {
sub runpdfTeX() {
sub runTeX {
sub savePreamble {			# create a preamble file
sub searchPS {				# search the PostScript parts
  system("bibtex $tempDir/$pdfname-pdf");	
      system("convert $imageDir/-000001.ppm  $imageDir/$filename-$imgNo.png"); 
  system("dvips $filename");
  system("latex $filename");	
  system("makeindex $tempDir/$pdfname-pdf.idx");	
  system("pdflatex $tempDir/$pdfname-pdf");
  system("pdflatex $tempDir/$pdfname-pdf");	
      system("pdftoppm -f 1 -l 1 -r $DPI $imageDir/$filename-$imgNo.pdf $imageDir/"); 
  system("ps2pdf $filename.ps");
      system("rm $imageDir/-00001.ppm"); 
--tempDir=<dir> 
                         "tempDir=s"  => \$tempDir,  # string
the Free Software Foundation; either version 2 of the License, or
# the Free Software Foundation; either version 2 of the License, or (at
This program is distributed in the hope that it will be useful,
# This program is distributed in the hope that it will be useful, but
# This program is free software; you can redistribute it and/or modify
This program is free software; you can redistribute it and/or modify
            $type=-1;
            $type = 1; 
          $type = 1; 
	      $type = -1; 
	  $type = -1;
          $type = 2; 
          $type = 2; 			
  unlink "$path$name.aux";
  unlink "$path$name.log";
  unlink "$path$name.preamble";
  unlink "$path$name-tmp.aux";
  unlink "$path$name-tmp.dvi";
  unlink "$path$name-tmp.log";
  unlink "$path$name-tmp.pdf";
  unlink "$path$name-tmp.ps";
  unlink "$path$name-tmp.tex";
    unlink "$tempDir/$pdfname-pdf.aux";
    unlink "$tempDir/$pdfname-pdf.log";
use File::Basename;			# scan argument
use File::Path;                         # creating/removing dirs
use Getopt::Long;			# read parameter
use IO::File;                           # simple IO operation
#----------------------- User part begin ------------------------
#----------------------- User part end ---------------------------
use strict;				# to be sure, that all is safe ... :-)
# v. 0.06				simplify the use of PSTricks with pdf
--verbose 
                         "verbose"    => \$verbose); # flag
#	we have now \begin{pspicture} or \begin{postscript}
  } # while (<FILE>)
    while (<FILEp>) { print FILEsub $_; }
  while (<FILE>) {			# read all until \begin{document}
  while (<FILE>) {			# scan the input file
# WITHOUT ANY WARRANTY; without even the implied warranty of
# your option) any later version.
# You should have received a copy of the GNU General Public License
You should have received a copy of the GNU General Public License
