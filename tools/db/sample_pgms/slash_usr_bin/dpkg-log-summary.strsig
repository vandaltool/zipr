            }
            'action': event_name,
            'binaries': [ ],
            binary_pkg = pkg
                    break
            continue
                continue
            'date': event_date.strftime("%Y-%m-%d"),
    dates = {}
    dates = dates.keys()
        dates[event_date] = True
    dates.sort()
def loadfile(filename):
def parse_dpkg_dates(dpkg_text):
def parse_dpkg(dpkg_text, start_date=None, end_date=None):
    dpkg_events = parse_dpkg(dpkg_text, start_date, end_date)
        dpkg_log_filename = args[0]
        dpkg_log_filename = '/var/log/dpkg.log'
    dpkg_text = loadfile(dpkg_log_filename)
        "-D", "--show-dates", action="store_true", dest="show_dates", default=False,
        "-e", "--end-date", dest="end_date", default=None,
        else:
    else:
        end_date = datetime.datetime.strptime(options.end_date, "%Y-%m-%d")
    end_date = None
                event['action'], event['source_package'], event['date'], event['time'], event['old_version'], event['new_version'])
        event_date = datetime.datetime.strptime(m.group(1), "%Y-%m-%d")
        event_dates = parse_dpkg_dates(dpkg_text)
        event_detail = m.group(4)
        event_name = m.group(3)
        #    event_name, source_pkg, source_pkg_event['date'], event_time, old_ver, new_ver)
    events = { }
            events[source_pkg] = [ ]
        events[source_pkg].append(source_pkg_event)
        event_time = m.group(2)
        for d in event_dates:
        for event in dpkg_events[pkg]:
    for line in dpkg_text.split("\n"):
    for pkg in pkgs:
            for source_pkg_event in events[source_pkg]:
    fp.close()
    fp = open(filename)
    from gettext import gettext as _
    gettext.textdomain('xdiagnose')
        help=_("List dates on which updates were performed"))
        help=_("Only include entries from this date and earlier (YYYY/MM/DD)"))
        help=_("Only include entries from this date forward (YYYY/MM/DD)"))
        help=_("Show debug messages"))
        if end_date and event_date > end_date:
        if event_name not in ['install', 'upgrade', 'remove']:
    if len(args) < 1:
        if len(result) > 1:
if __name__ == "__main__":
        if not m:
    if options.end_date:
    if options.show_dates:
    if options.start_date:
    if options.verbose:
            if source_event_found:
                if source_pkg_event['new_version'] == new_ver:
        if source_pkg in events:
        if start_date and event_date < start_date:
import datetime
    import gettext
    import optparse
import os
import re
import sys
            indent += ' '
        indent = ''
        m = re_dpkg.match(line)
            'new_version': new_ver,
# NOTE: Be careful to run this from the same distro version as the upgrade was done on
            'old_version': old_ver,
    (options, args) = parser.parse_args()
# otherwise, it may not be able to look up the proper packages.
    parser.add_option(
    parser = optparse.OptionParser(version="%prog %ver")
        [pkg, old_ver, new_ver] = event_detail.split(' ')
    pkgs = dpkg_events.keys()
    pkgs.sort()
        #print "%-8s %-30s %-12s %-12s %-30s %-30s" %(
            print d.strftime("%Y-%m-%d")
        print "Reading from %s" %(dpkg_log_filename)
            print "%s%-8s %-30s %-12s %-12s %-30s %-30s" %(indent,
    re_dpkg = re.compile(r'^(\d+-\d+-\d+) (\d\d:\d\d:\d\d) (\w+) (.*)$')
        result = os.popen("apt-cache show %s 2>/dev/null | grep ^Source" % (pkg)).read().split(': ')
    return dates
    return events
    return text
            source_event_found = False
                    source_event_found = True
            'source_package': source_pkg,
        source_pkg_event = {
                    source_pkg_event['binaries'].append(binary_pkg)
            source_pkg = pkg
            source_pkg = value.split("\n")[0]
        "-s", "--start-date", dest="start_date", default=None,
        start_date = datetime.datetime.strptime(options.start_date, "%Y-%m-%d")
    start_date = None
        sys.exit(0)
    sys.exit(0)
    text = fp.read()
            'time': event_time,
        # TODO: Create PackageEvent class
#!/usr/bin/python
            value = result[1].strip()
        "-v", "--verbose", action="store_true", dest="verbose", default=False,
